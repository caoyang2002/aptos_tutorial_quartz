---
title: æ— å¯†é’¥è´¦æˆ·
---
```yaml
original: "https://learn.aptoslabs.com/example/aptogotchi-keyless"
aip:
  zh: "https://github.com/ALCOVE-LAB/Aptos-Docs/blob/main/AIP/aip-61.md"
  en: "https://github.com/aptos-foundation/AIPs/blob/main/aips/aip-61.md"
  discussions: "aptos-foundation/AIPs#297"
note: æ­£åœ¨ç¼–è¾‘
```
![Image](https://mielgo-markdown.oss-cn-chengdu.aliyuncs.com/GJJRmgmWIAA7TRK.jpeg)



![Image](https://mielgo-markdown.oss-cn-chengdu.aliyuncs.com/GNo9sbwWoAAwQjV.jpeg)

å…³äº Keyless çš„æ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹ [[AIP-61]]



# é›†æˆæ— å¯†é’¥è´¦æˆ·çš„æ­¥éª¤

> æ³¨æ„ï¼šæ— å¯†é’¥è´¦æˆ·çš„èŒƒå›´
> ä½¿ç”¨æ­¤é›†æˆæŒ‡å—å°†å…è®¸ä½ å°†æ— é’¥åŒ™è´¦æˆ·ç›´æ¥é›†æˆåˆ°ä½ çš„åº”ç”¨ç¨‹åºä¸­ã€‚è¿™æ„å‘³ç€åŒºå—é“¾è´¦æˆ·è¢«é™å®šåœ¨ä½ åº”ç”¨ç¨‹åºçš„åŸŸå†…ï¼ˆä¾‹å¦‚ï¼Œåœ¨ dApp A ä¸Šç”¨ä½ çš„ Google è´¦æˆ·ç™»å½•ï¼Œå’Œåœ¨ dApp B ä¸Šç”¨ä½ çš„ Google è´¦æˆ·ç™»å½•å°†ä¼šåˆ›å»ºä¸åŒçš„è´¦æˆ·ï¼‰ã€‚

æ•¬è¯·æœŸå¾… Aptos è®¡åˆ’å…è®¸æ— é’¥åŒ™è´¦æˆ·è·¨åº”ç”¨ç¨‹åºä¾¿æºä½¿ç”¨çš„æ›´å¤šå†…å®¹ã€‚



## æ­¥éª¤æ¦‚è§ˆ

æ¦‚æ‹¬æ¥è¯´ï¼Œé›†æˆæ— å¯†é’¥è´¦æˆ·éœ€è¦éµå¾ªä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ã€‚

1. é…ç½®ä½ çš„èº«ä»½æä¾›è€…ï¼ˆ`IdP`ï¼‰çš„ `OpenID` é›†æˆã€‚
   åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œ`dApp` å°†ä¸ä½ é€‰æ‹©çš„ `IdP`ï¼ˆä¾‹å¦‚ Googleï¼‰æ³¨å†Œå¹¶æ¥æ”¶ä¸€ä¸ª `client_id`ã€‚

2. å®‰è£… `Aptos TypeScript SDK`ã€‚
   åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­å®‰è£… `Aptos` çš„ `TypeScript` è½¯ä»¶å¼€å‘å·¥å…·åŒ…ã€‚

3. åœ¨ä½ çš„åº”ç”¨ç¨‹åºå®¢æˆ·ç«¯é›†æˆæ— é’¥åŒ™è´¦æˆ·æ”¯æŒã€‚
   - ä¸ºä½ çš„ç”¨æˆ·è®¾ç½®â€œ\[IdP]ç™»å½•â€æµç¨‹ã€‚
   - å®ä¾‹åŒ–ç”¨æˆ·çš„æ— å¯†é’¥è´¦æˆ·ã€‚
   - é€šè¿‡æ— å¯†é’¥è´¦æˆ·ç­¾ç½²å¹¶æäº¤äº¤æ˜“ã€‚



# ä¸€ã€é…ç½®æ‚¨çš„ `OpenID` é›†æˆ

æ”¯æŒçš„èº«ä»½æä¾›è€…

ç›®å‰åªæ”¯æŒGoogleã€‚æˆ‘ä»¬å°†åœ¨å°†æ¥æ”¯æŒå…¶ä»– OIDC æä¾›ç¨‹åºï¼ˆä¾‹å¦‚è‹¹æœã€Kakaotalkã€å¾®è½¯ç­‰ï¼‰ã€‚


| èº«ä»½æä¾›è€…  | è®¤è¯URL                                                                                                                                                                                        |
| ------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Google | `https://accounts.google.com/o/oauth2/v2/auth/oauthchooseaccount?client_id=$%7BCLIENT_ID%7D&redirect_uri=$%7BREDIRECT_URI%7D&response_type=id_token&scope=openid%20email&nonce=$%7BNONCE%7D` |

éšå¼æµç¨‹ï¼ˆæ— æˆæƒç äº¤æ¢ï¼‰æ˜¯é¦–é€‰çš„èº«ä»½éªŒè¯æ–¹æ³•ã€‚ä¸‹é¢çš„é›†æˆæ­¥éª¤å‡å®šä½¿ç”¨éšå¼æµç¨‹ã€‚

## Google

ä¸ºäº†æ”¯æŒ `OpenID` èº«ä»½éªŒè¯ï¼Œæ‚¨éœ€è¦ä» Google è·å– `client_id`ï¼Œå¹¶è®¾ç½®æˆæƒæ¥æºå’Œé‡å®šå‘ URIã€‚

åœ¨ [Google API æ§åˆ¶å°](https://console.developers.google.com/) ä¸­è®¾ç½®æ‚¨çš„é¡¹ç›®ã€‚

æ³¨å†Œ Google äº‘è´¦æˆ·ï¼ˆå¦‚æœæ‚¨è¿˜æ²¡æœ‰ï¼‰

1. åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®
    - ä¸Šæ–¹çš„`ä¸‹æ‹‰é€‰æ‹©å™¨`ä¸­`åˆ›å»ºé¡¹ç›®` -> åœ¨`å·¦ä¾§èœå•`ä¸­é€‰æ‹© `API å’ŒæœåŠ¡` -> `å‡­æ®` -> ä¸Šæ–¹`åˆ›å»ºå‡­æ®` -> `OAuth å®¢æˆ·ç«¯ ID`  -> `é…ç½®åŒæ„å±å¹•` -> `å¤–éƒ¨` -> `åˆ›å»º` -> `å‘å¸ƒåº”ç”¨` -> `æäº¤éªŒè¯`


<iframe width="800" height="450" src="https://learn.aptoslabs.com/videos/google_api_console.mov" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

2. è½¬åˆ°[å‡­æ®](https://console.developers.google.com/apis/credentials)é¡µé¢ã€‚
    - `åˆ›å»ºå‡­æ®` -> `åˆ›å»º OAuth å®¢æˆ·ç«¯ ID`
3. å¦‚æœä¹‹å‰æ²¡æœ‰è®¾ç½®è¿‡OAuthåŒæ„å±å¹•ï¼Œæ‚¨å¯èƒ½éœ€è¦è¿›è¡Œè®¾ç½®ã€‚
    - è¿™æ˜¯æ‚¨å°†ä¸ºåº”ç”¨ç¨‹åºé…ç½®ä¸€äº›åº”ç”¨ä¿¡æ¯ä»¥åŠåº”ç”¨ç¨‹åºçš„ä½œç”¨åŸŸå’Œæƒé™çš„åœ°æ–¹ã€‚

<iframe width="800" height="450" src="https://learn.aptoslabs.com/videos/credentials_to_consent_screen.mov" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

4. é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„â€œOAuth 2.0 Client IDâ€ã€‚
5. é…ç½®æˆæƒæ¥æºï¼ˆæ‚¨çš„dAppæ¥æºï¼‰ã€‚

    - è¿™å¯èƒ½æ˜¯ `http://localhost:3000` ç”¨äºæœ¬åœ°å¼€å‘ã€‚
    - ç¡®ä¿åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºåæ›´æ–°è¿™äº›æ¥æºã€‚
6. é…ç½®é‡å®šå‘URIï¼ˆåœ¨èº«ä»½éªŒè¯åæ¥æ”¶æˆæƒç å’Œ/æˆ– `id_token` çš„å›è°ƒå¤„ç†ç¨‹åºï¼‰ã€‚
    - ä¾‹å¦‚ï¼š `http://localhost:3000/callback` ç”¨äºæœ¬åœ°å¼€å‘ã€‚
7. è·å–æ‚¨çš„åº”ç”¨ç¨‹åºçš„ `client_id`ã€‚
    - å°†å…¶ä¿å­˜åœ¨æ‚¨çš„ `.env` å˜é‡æˆ–å¸¸é‡æ–‡ä»¶ä¸­ã€‚

<iframe width="800" height="450" src="https://learn.aptoslabs.com/videos/create_client_id.mov" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>




# äºŒã€å®‰è£… `Aptos-TS-SDK`

```bash
# æ”¯æŒæ— å¯†é’¥åŠŸèƒ½çš„å®éªŒæ€§ SDK ç‰ˆæœ¬
pnpm install @aptos-labs/ts-sdk@zeta
```

æ³¨æ„ï¼šè¯¥ SDK æ˜¯å®éªŒæ€§çš„ã€‚

API å’Œ SDK ä»åœ¨ç§¯æå¼€å‘ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ `@zeta` æ ‡ç­¾ä¸‹çš„ç‰ˆæœ¬ã€‚

å¦‚æœæ‚¨çš„é›†æˆåœæ­¢å·¥ä½œï¼Œè¯·å°è¯•å°†è¯¥åŒ…å‡çº§åˆ° SDK çš„æœ€æ–° `@zeta` ç‰ˆæœ¬ã€‚è¿™ä¸ªç‰ˆæœ¬å¯èƒ½ç¼ºå°‘éå®éªŒæ€§ SDK çš„ä¸€äº›åŠŸèƒ½ã€‚



# ä¸‰ã€è®¾ç½®ä¸´æ—¶å¯†é’¥

è®¾ç½®ä¸€ä¸ªä¸´æ—¶å¯†é’¥å¯¹

1. åˆ›å»ºä¸€ä¸ªæ–°çš„ `useEphemeralKeyPair()` é’©å­ï¼Œç”¨äºå­˜å‚¨åˆ›å»ºå’Œä¿å­˜ä¸´æ—¶å¯†é’¥å¯¹çš„æ‰€æœ‰é€»è¾‘ã€‚
	- å°†ä¸´æ—¶å¯†é’¥å¯¹ä¿å­˜åœ¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œä»¥å®ƒçš„ `nonce` ä½œä¸ºé”®

```ts title="hooks/useEphemeralKeyPair.ts"
import { EphemeralKeyPair } from '@aptos-labs/ts-sdk';

export default function useEphemeralKeyPair() {
  const ephemeralKeyPair = EphemeralKeyPair.generate();
  storeEphemeralKeyPair(ephemeralKeyPair);

  return ephemeralKeyPair;
}
```


2. `storeEphemeralKeyPair()`çš„ç¤ºä¾‹å®ç°ï¼š
>[!TIP]
>è¿™ä¸ªå®ç°æ˜¯å°†ä¸´æ—¶å¯†é’¥å¯¹ä½¿ç”¨éšæœºæ•°ä½œä¸ºé”®å­˜å‚¨åœ¨æœ¬åœ°å­˜å‚¨ä¸­çš„ç¤ºä¾‹ã€‚æ ¹æ®ä½ çš„åº”ç”¨éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„å®ç°æ–¹å¼ã€‚


```ts title="hooks/useEphemeralKeyPair.ts"
/**
 * åœ¨localStorageä¸­å­˜å‚¨ä¸´æ—¶å¯†é’¥å¯¹ï¼ˆnonce -> ephemeralKeyPairï¼‰
 */
export type StoredEphemeralKeyPairs = { [nonce: string]: EphemeralKeyPair };

/**
 * ä»localStorageä¸­æ£€ç´¢æ‰€æœ‰ä¸´æ—¶å¯†é’¥å¯¹å¹¶å¯¹å®ƒä»¬è¿›è¡Œè§£ç ã€‚ç„¶åï¼Œæ–°çš„ä¸´æ—¶å¯†é’¥å¯¹å°†ä½¿ç”¨nonceä½œä¸ºé”®å­˜å‚¨åœ¨localStorageä¸­ã€‚
*/
export const storeEphemeralKeyPair = (
  ephemeralKeyPair: EphemeralKeyPair,
): void => {
  // ä»localStorageä¸­æ£€ç´¢å½“å‰çš„ä¸´æ—¶å¯†é’¥å¯¹
  const accounts = getLocalEphemeralKeyPairs();

  // åœ¨localStorageä¸­å­˜å‚¨æ–°çš„ä¸´æ—¶å¯†é’¥å¯¹
  accounts[ephemeralKeyPair.nonce] = ephemeralKeyPair;
  localStorage.setItem(
    "ephemeral-key-pairs",
    encodeEphemeralKeyPairs(accounts),
  );
};

/**
 * ä»localStorageä¸­æ£€ç´¢æ‰€æœ‰ä¸´æ—¶å¯†é’¥å¯¹å¹¶å¯¹å®ƒä»¬è¿›è¡Œè§£ç ã€‚
 */
export const getLocalEphemeralKeyPairs = (): StoredEphemeralKeyPairs => {
  const rawEphemeralKeyPairs = localStorage.getItem("ephemeral-key-pairs");
  try {
    return rawEphemeralKeyPairs
      ? decodeEphemeralKeyPairs(rawEphemeralKeyPairs)
      : {};
  } catch (error) {
    // eslint-disable-next-line no-console
    console.warn(
      "æ— æ³•ä»localStorageè§£ç ä¸´æ—¶å¯†é’¥å¯¹",
      error,
    );
    return {};
  }
};

/**
 * ç”¨äºåœ¨localStorageä¸­å­˜å‚¨çš„EphemeralKeyPairç±»çš„ç¼–ç 
 */
const EphemeralKeyPairEncoding = {
  decode: (e: any) => EphemeralKeyPair.fromBytes(e.data),
  encode: (e: EphemeralKeyPair) => ({ __type: 'EphemeralKeyPair', data: e.bcsToBytes() }),
};

/**
 * å°†ä¸´æ—¶å¯†é’¥å¯¹å­—ç¬¦ä¸²åŒ–ï¼Œä»¥ä¾¿å­˜å‚¨åœ¨localStorageä¸­
 */
export const encodeEphemeralKeyPairs = (
  keyPairs: StoredEphemeralKeyPairs,
): string =>
  JSON.stringify(keyPairs, (_, e) => {
    if (typeof e === "bigint") return { __type: "bigint", value: e.toString() };
    if (e instanceof Uint8Array)
      return { __type: "Uint8Array", value: Array.from(e) };
    if (e instanceof EphemeralKeyPair)
      return EphemeralKeyPairEncoding.encode(e);
    return e;
  });

/**
 * ä»å­—ç¬¦ä¸²ä¸­è§£æä¸´æ—¶å¯†é’¥å¯¹
 */
export const decodeEphemeralKeyPairs = (
  encodedEphemeralKeyPairs: string,
): StoredEphemeralKeyPairs =>
  JSON.parse(encodedEphemeralKeyPairs, (_, e) => {
    if (e && e.__type === "bigint") return BigInt(e.value);
    if (e && e.__type === "Uint8Array") return new Uint8Array(e.value);
    if (e && e.__type === "EphemeralKeyPair")
      return EphemeralKeyPairEncoding.decode(e);
    return e;
  });

export default function useEphemeralKeyPair() {
  const ephemeralKeyPair = EphemeralKeyPair.generate();
  storeEphemeralKeyPair(ephemeralKeyPair);

  return ephemeralKeyPair;
}
```


3. åœ¨æ—§çš„ `WalletButtons`ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬åœ¨åå°åˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶å¯†é’¥å¯¹ã€‚

```ts title="WalletButtons/index.tsx"
import { useKeylessAccount } from "@/context/KeylessAccountContext";

const ephemeralKeyPair = useEphemeralKeyPair();
```



# å››ã€è®¾ç½®ç™»å½•æŒ‰é’®

## è®¾ç½® OAuth æµç¨‹

1. ç§»é™¤æ‰€æœ‰æåŠ `@aptos-labs/wallet-adapter-react` çš„å†…å®¹ï¼Œå¹¶å°†ä»¥ä¸‹ä»£ç é€»è¾‘æ’å…¥ `WalletButtons` ç»„ä»¶ä¸­ã€‚
	- ä½ ä¹Ÿå¯ä»¥ä»æ ¹å¸ƒå±€ä¸­ç§»é™¤ `WalletProvider`

2. å‡†å¤‡ç™»å½• `URL` çš„å‚æ•°ã€‚
	- å°† `redirect_uri` å’Œ `client_id` è®¾ç½®ä¸ºæ‚¨ä¸ `IdP` é…ç½®çš„å€¼ã€‚
	- å°† `nonce` è®¾ç½®ä¸ºå‰ä¸€æ­¥ä¸­ `EphemeralKeyPair` çš„ `nonce`ã€‚
1. æ„å»ºç”¨æˆ·ä¸ `IdP` è®¤è¯çš„ç™»å½• `URL`
	- ç¡®ä¿è®¾ç½®äº† `openid` ä½œç”¨åŸŸã€‚æ ¹æ®ä½ çš„åº”ç”¨ç¨‹åºéœ€æ±‚ï¼Œå¯ä»¥è®¾ç½®å…¶ä»–ä½œç”¨åŸŸï¼Œå¦‚ `email` å’Œ `profile`

```ts title="WalletButtons/index.tsx"
const redirectUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
const searchParams = new URLSearchParams({
  /**
   * ç”¨æ‚¨è‡ªå·±çš„å®¢æˆ·ç«¯ ID æ›¿æ¢
   */
  client_id: process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID,
  /**
   * redirect_uri å¿…é¡»åœ¨ Google Developer Console ä¸­æ³¨å†Œã€‚è¿™ä¸ªå›è°ƒé¡µé¢
   * ä» URL ç‰‡æ®µè§£æ id_tokenï¼Œå¹¶å°†å…¶ä¸ä¸´æ—¶å¯†é’¥å¯¹ç»“åˆ
   * ä»¥æ´¾ç”Ÿæ— é’¥åŒ™è´¦æˆ·ã€‚
   * 
   * window.location.origin == http://localhost:3000
   */
  redirect_uri: `${window.location.origin}/callback`,
  /**
   * è¿™ä½¿ç”¨ OpenID Connect éšå¼æµç¨‹è¿”å› id_tokenã€‚è¿™è¢«æ¨èç”¨äº SPAsï¼ˆå•é¡µåº”ç”¨ç¨‹åºï¼‰ï¼Œå› ä¸ºå®ƒä¸éœ€è¦åç«¯æœåŠ¡å™¨ã€‚
   */
  response_type: "id_token",
  scope: "openid email profile",
  nonce: ephemeralKeyPair.nonce,
});
redirectUrl.search = searchParams.toString();
```

å½“ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®æ—¶ï¼Œå°†ç”¨æˆ·é‡å®šå‘åˆ°ä½ åˆšåˆšåˆ›å»ºçš„ `redirectUrl`ã€‚

```ts title="WalletButtons/index.tsx"
<a href={redirectUrl.toString()}>
  <button>Sign in with Google</button>
</a>
```



# äº”ã€åˆ›å»ºå›è°ƒé¡µé¢

## è§£æ JWT å¹¶æ£€ç´¢ä¸´æ—¶å¯†é’¥å¯¹

1. åœ¨åº”ç”¨ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒé¡µé¢æ¥å¤„ç† `IdP` ç™»å½•æµç¨‹ã€‚

å‰ç«¯æ–‡ä»¶ç»“æ„

```bash
â”œâ”€ src    
â”‚  â””â”€ app
â”‚     â””â”€ callback
â”‚        â””â”€ page.tsx // åˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒé¡µé¢æ¥ä¿å­˜è¿™ä¸ªé€»è¾‘
```

2. ç”¨æˆ·å®Œæˆç™»å½•æµç¨‹åï¼Œå°†è¢«é‡å®šå‘åˆ°å‰é¢è®¾ç½®çš„ `redirect_uri`
	- JWT å°†ä½œä¸ºä¸€ä¸ªæœç´¢å‚æ•°åœ¨ URL ç‰‡æ®µä¸­è®¾ç½®ï¼Œé€šè¿‡ `id_token` ä½œä¸ºé”®ã€‚
	- é€šè¿‡ä»¥ä¸‹æ–¹å¼ä»çª—å£ä¸­æå– JWTï¼š

```ts title="callback/page.tsx"
const parseJWTFromURL = (url: string): string | null => {
  const urlObject = new URL(url);
  const fragment = urlObject.hash.substring(1);
  const params = new URLSearchParams(fragment);
  return params.get('id_token');
};

// window.location.href = https://.../callback#id_token=...
const jwt = parseJWTFromURL(window.location.href);
```

3. è§£ç  JWT å¹¶ä»è´Ÿè½½ä¸­æå– `nonce` å€¼ã€‚

```ts title="callback/page.tsx"
import { jwtDecode } from 'jwt-decode';

const payload = jwtDecode<{ nonce: string }>(jwt);
const jwtNonce = payload.nonce;
```

4. ä½¿ç”¨è§£ç åçš„ nonce è·å–Â `EphemeralKeyPair`ï¼ˆåœ¨ç™»å½•æµç¨‹å‰å­˜å‚¨ï¼‰ã€‚

```javascript
const ephemeralKeyPair = getLocalEphemeralKeyPair(jwtNonce);
```

5. è·å–æœ¬åœ°ä¸´æ—¶å¯†é’¥å¯¹çš„ç¤ºä¾‹å®ç°ï¼š
	- è¿™åŒ…æ‹¬ä¸´æ—¶å¯†é’¥å¯¹çš„éªŒè¯å’Œç§»é™¤

	>[!NOTE]
	>æ ¹æ®ä¸åŒåº”ç”¨ç¨‹åºçš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„å®ç°æ–¹å¼ã€‚é‡è¦çš„æ˜¯è¦éªŒè¯ä¸´æ—¶å¯†é’¥å¯¹çš„è¿‡æœŸæ—¶é—´æˆ³ï¼Œä»¥ç¡®ä¿å®ƒä»ç„¶æœ‰æ•ˆã€‚

```ts title="callback/page.tsx"
/**
 * ä»localStorageä¸­æ£€ç´¢ç»™å®š nonce çš„ä¸´æ—¶å¯†é’¥å¯¹ã€‚
 */
export const getLocalEphemeralKeyPair = (
  nonce: string,
): EphemeralKeyPair | null => {
  const keyPairs = getLocalEphemeralKeyPairs();

  // ä½¿ç”¨ç»™å®š nonce è·å–è´¦æˆ·ï¼ˆç”Ÿæˆçš„ nonce å¯èƒ½ä¸ localStorage ä¸­çš„ nonce ä¸åŒ¹é…ï¼‰
  // å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿”å›ä¹‹å‰éªŒè¯å®ƒï¼ˆç‰¹å®šäºå®ç°ï¼‰ã€‚
  const ephemeralKeyPair = keyPairs[nonce];
  if (!ephemeralKeyPair) return null;

  // å¦‚æœè´¦æˆ·æœ‰æ•ˆï¼Œåˆ™è¿”å›å®ƒï¼Œå¦åˆ™ä»è®¾å¤‡ä¸­ç§»é™¤å¹¶è¿”å› null
  return validateEphemeralKeyPair(nonce, ephemeralKeyPair);
};

/**
 * ä½¿ç”¨ç»™å®šçš„ nonce å’Œè¿‡æœŸæ—¶é—´æˆ³éªŒè¯ä¸´æ—¶å¯†é’¥å¯¹ã€‚å¦‚æœ nonce ä¸ä¸´æ—¶å¯†é’¥å¯¹ç”Ÿæˆçš„ nonce ä¸åŒ¹é…ï¼Œ
 * åˆ™ä» localStorage ä¸­ç§»é™¤ä¸´æ—¶å¯†é’¥å¯¹ã€‚è¿™æ˜¯ä¸ºäº†éªŒè¯ nonce ç®—æ³•æ˜¯å¦ç›¸åŒï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ nonce ç®—æ³•å‘ç”Ÿäº†å˜åŒ–ï¼‰ã€‚
 */
export const validateEphemeralKeyPair = (
  nonce: string,
  ephemeralKeyPair: EphemeralKeyPair,
): EphemeralKeyPair | null => {
  // æ£€æŸ¥è´¦æˆ·çš„ nonce å’Œè¿‡æœŸæ—¶é—´æˆ³ï¼Œçœ‹å®ƒæ˜¯å¦æœ‰æ•ˆ
  if (
    nonce === ephemeralKeyPair.nonce &&
    ephemeralKeyPair.expiryDateSecs > BigInt(Math.floor(Date.now() / 1000))
  ) {
    return ephemeralKeyPair;
  }
  removeEphemeralKeyPair(nonce);
  return null;
};

/**
 * ä»localStorageä¸­ç§»é™¤ç»™å®š nonce çš„ä¸´æ—¶å¯†é’¥å¯¹ã€‚
 */
export const removeEphemeralKeyPair = (nonce: string): void => {
  const keyPairs = getLocalEphemeralKeyPairs();
  delete keyPairs[nonce];
  localStorage.setItem(
    "ephemeral-key-pairs",
    encodeEphemeralKeyPairs(keyPairs),
  );
};
```



# å…­ã€å®ä¾‹åŒ–æ— å¯†é’¥è´¦æˆ·

## åˆ›å»ºæ— å¯†é’¥è´¦æˆ·

1. é…ç½® Aptos å®¢æˆ·ç«¯

```ts title="utils/aptosClient.ts"
import { Aptos, AptosConfig, Network } from "@aptos-labs/ts-sdk";

export function getAptosClient() {
  // æˆ–è€… Network.DEVNETï¼ˆç¡®ä¿ä½ çš„ç½‘ç»œåœ¨åº”ç”¨ç¨‹åºä¸­ä¿æŒä¸€è‡´ï¼‰
  const config = new AptosConfig({ network: Network.TESTNET });
  return new Aptos(config);
}
```

2. å®ä¾‹åŒ–ç”¨æˆ·çš„æ— å¯†é’¥è´¦æˆ·

```ts title="callback/page.tsx"
const aptosClient = getAptosClient();

const keylessAccount = await aptosClient.deriveKeylessAccount({
  jwt,
  ephemeralKeyPair,
});
```

3. å°±æ˜¯è¿™æ ·ï¼ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–°çš„æ— å¯†é’¥è´¦æˆ·åˆ›å»ºå’Œæäº¤äº¤æ˜“äº†ï¼ğŸ¤¯

	- ç¤ºä¾‹ï¼šé“¸é€  Aptogotchi åˆ°æ— é’¥åŒ™è´¦æˆ·

```ts title="Mint/index.tsx"
const handleMint = async () => {
  if (!keylessAccount) return;

  const transaction = await aptosClient.transaction.build.simple({
    sender: keylessAccount.accountAddress,
    data: {
      function: `${NEXT_PUBLIC_CONTRACT_ADDRESS}::main::create_aptogotchi`,
      typeArguments: [],
      functionArguments: [name, petParts.body, petParts.ear, petParts.face],
    },
  });

  try {
    const committedTxn = await aptosClient.signAndSubmitTransaction({
      signer: keylessAccount,
      transaction,
    });
    await aptosClient.waitForTransaction({
      transactionHash: committedTxn.hash,
    });
  } catch (error: any) {
    console.error(error);
  }
};
```


>[!NOTE]
>ç®¡ç†æ— é’¥åŒ™è´¦æˆ·çŠ¶æ€
>
>ä¸ºäº†åœ¨åº”ç”¨ç¨‹åºä¸­è®¿é—®è¿™ä¸ªæ— é’¥åŒ™è´¦æˆ·ï¼Œä½ å¯ä»¥ä½¿ç”¨çŠ¶æ€ç®¡ç†åº“ï¼Œå¦‚ React Contextã€Redux æˆ– Zustandï¼ˆå–å†³äºä½ çš„åº”ç”¨ç¨‹åºå¤æ‚æ€§å’Œä½ çš„ç‰¹å®šéœ€æ±‚ï¼‰ã€‚

> ç¤ºä¾‹ï¼šä½¿ç”¨ React Context

```ts title="context/KeylessAccountContext.tsx"
"use client";

import React, { createContext, useContext, useState } from "react";
import { Account } from "@aptos-labs/ts-sdk";

interface KeylessAccountContextType {
  keylessAccount: Account | null;
  setKeylessAccount: (account: Account | null) => void;
}

const KeylessAccountContext = createContext<KeylessAccountContextType | undefined>(undefined);

export const KeylessAccountProvider: React.FC<{
  children: React.ReactNode;
}> = ({ children }) => {
  const [keylessAccount, setKeylessAccount] = useState<Account | null>(null);

  return (
    <KeylessAccountContext.Provider
      value={{ keylessAccount, setKeylessAccount }}
    >
      {children}
    </KeylessAccountContext.Provider>
  );
};

export const useKeylessAccount = () => {
  const context = useContext(KeylessAccountContext);
  if (!context) {
    throw new Error(
      "useKeylessAccount must be used within a KeylessAccountProvider"
    );
  }
  return context;
};
```

[Github repository](https://github.com/darren-wangg/aptogotchi-keyless)Â 
